import { getaddrinfo, Getaddrinfo, Tcp, Connect } from 'uv';

/// <reference path="../lib.uv.d.ts"/>

function makeCallback () {
  let callback, promise;
  promise = new Promise((resolve, reject) => {
    callback = (err, val) => err ? reject(err) : resolve(val);
  });
  callback.promise = promise;
  return callback;
}

async function connect (host, service) {
  // Resolve IP address and TCP port
  let cb = makeCallback();
  getaddrinfo(new Getaddrinfo(), cb, host, '' + service);
  let [{ ip, port }] = await cb.promise;

  // Connect to server
  let socket = new Tcp();
  cb = makeCallback();
  socket.connect(new Connect(), ip, port, cb);
  await cb.promise;

  return socket;
}

export { connect };
